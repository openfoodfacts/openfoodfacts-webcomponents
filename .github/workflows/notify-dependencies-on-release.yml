name: Notify dependency repositories on release

on:
  release:
    types: [published]

permissions:
  issues: write
  contents: read

jobs:
  notify-dependencies:
    runs-on: ubuntu-latest
    if: github.event.release.draft == false && github.event.release.prerelease == false
    
    strategy:
      matrix:
        repository:
          - openfoodfacts/openfoodfacts-server
          - openfoodfacts/openfoodfacts-explorer
          - openfoodfacts/hunger-games
      fail-fast: false  # Continue with other repos even if one fails
    
    steps:
      - name: Create issue in ${{ matrix.repository }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const version = context.payload.release.tag_name;
            const releaseUrl = context.payload.release.html_url;
            const releaseBody = context.payload.release.body || '';
            const packageName = '@openfoodfacts/openfoodfacts-webcomponents';
            
            // Extract repository owner and name from matrix
            const [owner, repo] = '${{ matrix.repository }}'.split('/');
            
            // Create issue title
            const title = `Update ${packageName} to ${version}`;
            
            // Create issue body with release information
            const body = [
              '## üì¶ New Version Available',
              '',
              `A new version of ${packageName} has been released: **${version}**`,
              '',
              '### üîó Release Information',
              `- **Version**: ${version}`,
              `- **Release URL**: ${releaseUrl}`,
              `- **NPM Package**: https://www.npmjs.com/package/${packageName}`,
              '',
              '### üìã Release Notes',
              releaseBody,
              '',
              '### üöÄ Action Required',
              `Please update the dependency in this repository to use the latest version of ${packageName}.`,
              '',
              'To update:',
              `1. Update your \`package.json\` to use version \`${version}\``,
              `2. Run \`npm install\` or \`npm update ${packageName}\``,
              '3. Test the integration to ensure everything works as expected',
              '4. Deploy the changes',
              '',
              '---',
              `*This issue was automatically created by the [openfoodfacts-webcomponents release workflow](${context.payload.repository.html_url}/actions).*`
            ].join('\n');

            try {
              const issue = await github.rest.issues.create({
                owner: owner,
                repo: repo,
                title: title,
                body: body,
                labels: ['dependencies', 'webcomponents-update']
              });
              
              console.log(`‚úÖ Created issue #${issue.data.number} in ${owner}/${repo}: ${issue.data.html_url}`);
            } catch (error) {
              console.error(`‚ùå Failed to create issue in ${owner}/${repo}:`, error.message);
              
              // If it's a permissions error, provide helpful information
              if (error.status === 403 || error.status === 404) {
                console.error('This might be due to insufficient permissions or the repository not existing.');
                console.error('Make sure the GITHUB_TOKEN has write access to issues in the target repository.');
              }
              
              throw error;  // Re-throw to mark the step as failed
            }